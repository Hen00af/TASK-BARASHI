<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ã‚¿ã‚¹ã‚¯ã°ã‚‰ã—ï¼ˆãƒãƒƒã‚«ã‚½ãƒ³ç”¨ãƒ»å˜ä¸€HTMLï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --ink:#1f2937;
    --muted:#6b7280; --ring:#e5e7eb; --shadow:0 8px 20px rgba(16,24,40,.06);
    --green:#22c55e; --blue:#38bdf8; --gray:#d1d5db;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:24px; background:var(--bg); color:var(--ink);
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  h1{font-size:20px;margin:0 0 16px}
  .bar{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    padding:12px; background:var(--card); border:1px solid var(--ring);
    border-radius:12px; box-shadow:var(--shadow); margin-bottom:16px;
  }
  input,select,button{
    height:40px; padding:0 12px; border-radius:10px; border:1px solid var(--ring);
    background:#fff; color:var(--ink); font-size:14px;
  }
  button{cursor:pointer}
  button.primary{background:#111827; color:#fff; border-color:#111827}
  button.ghost{background:transparent}
  small.muted{color:var(--muted)}
  .grid{
    display:grid; gap:16px;
    grid-template-columns: 1.2fr .8fr;
  }
  @media (max-width:900px){ .grid{grid-template-columns: 1fr} }

  .panel{
    background:var(--card); border:1px solid var(--ring); border-radius:12px;
    box-shadow:var(--shadow);
  }
  .panel header{
    padding:12px 16px; border-bottom:1px solid var(--ring);
    display:flex; justify-content:space-between; align-items:center;
  }
  .panel .content{ padding:12px 16px; }

  ul.tree{list-style:none; padding-left:0; margin:0}
  li.task{
    list-style:none; margin:10px 0; padding:10px; border:1px solid var(--ring);
    border-radius:10px; background:#fff;
  }
  .row{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  .title{font-weight:600}
  .badge{
    font-weight:700; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--ring);
  }
  .æœªç€æ‰‹{background:#f3f4f6}
  .ä½œæ¥­ä¸­{background:#e0f2fe; border-color:#bae6fd}
  .å®Œäº†{background:#dcfce7; border-color:#bbf7d0; color:#065f46}

  .actions button{height:32px}
  .progress{height:8px; background:var(--gray); border-radius:999px; overflow:hidden}
  .progress > span{display:block; height:100%; background:var(--green); width:0; transition:width .25s ease}

  .stats-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .chip{padding:6px 10px; border-radius:999px; background:#f3f4f6; border:1px solid var(--ring); font-size:12px}
  .ownerbar{height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; width:140px}
  .ownerbar > span{display:block; height:100%; background:var(--blue); width:0}
  .footer-note{margin-top:6px}
</style>
</head>
<body>
  <h1>ã‚¿ã‚¹ã‚¯ã°ã‚‰ã—ï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«å®Œçµï¼‰</h1>

  <!-- å…¥åŠ›ãƒãƒ¼ -->
  <div class="bar">
    <input id="taskInput" placeholder="ã‚¿ã‚¹ã‚¯å" style="min-width:220px" />
    <input id="ownerInput" placeholder="æ‹…å½“è€…ï¼ˆæœªå®šå¯ï¼‰" style="min-width:160px" />
    <select id="parentSelect" title="è¦ªã‚¿ã‚¹ã‚¯">
      <option value="">ï¼ˆè¦ªã‚¿ã‚¹ã‚¯ãªã—ï¼‰</option>
    </select>
    <button class="primary" id="addBtn">è¿½åŠ </button>
    <span style="flex:1"></span>
    <button id="toggleStatsBtn">ğŸ“Š çµ±è¨ˆã‚’è¡¨ç¤º/éè¡¨ç¤º</button>
    <button id="exportJsonBtn">ğŸ’¾ ä¿å­˜ï¼ˆå¾©å…ƒç”¨JSONï¼‰</button>
    <button id="exportMdBtn">ğŸ“„ ä¿å­˜ï¼ˆMarkdownï¼‰</button>
    <label class="ghost" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
      <input type="file" id="fileInput" style="display:none" />
      <span>ğŸ“‚ èª­ã¿è¾¼ã¿</span>
    </label>
  </div>
  <div class="footer-note"><small class="muted">â€» ã€Œå¾©å…ƒç”¨JSONã€ã¯ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ï¼ˆéšå±¤ãƒ»æ‹…å½“ãƒ»çŠ¶æ…‹ï¼‰ã‚’ãã®ã¾ã¾å¾©å…ƒã§ãã¾ã™ã€‚</small></div>

  <div class="grid">
    <!-- ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ -->
    <section class="panel">
      <header>
        <strong>ã‚¿ã‚¹ã‚¯ä¸€è¦§</strong>
        <div class="stats-row" id="topCounters"></div>
      </header>
      <div class="content">
        <ul class="tree" id="taskList"></ul>
      </div>
    </section>

    <!-- çµ±è¨ˆ -->
    <section class="panel" id="statsPanel" style="display:none">
      <header><strong>çµ±è¨ˆ / é€²æ—</strong></header>
      <div class="content" id="statsContent">
        <!-- å‹•çš„ã«æç”» -->
      </div>
    </section>
  </div>

<script>
  // ===================== ãƒ‡ãƒ¼ã‚¿ =====================
  let tasks = [];        // éšå±¤ãƒ„ãƒªãƒ¼
  let taskId = 0;        // è‡ªå‹•ID
  const STATUS = ["æœªç€æ‰‹","ä½œæ¥­ä¸­","å®Œäº†"];

  // èµ·å‹•æ™‚ï¼šlocalStorageã‹ã‚‰è‡ªå‹•å¾©å…ƒ
  (function boot(){
    try{
      const cached = localStorage.getItem("taskbreak_v1");
      if (cached){
        tasks = JSON.parse(cached);
        taskId = findMaxId(tasks) + 1;
      }
    }catch(e){ console.warn(e); }
    render();
  })();

  // ===================== è¿½åŠ ãƒ»ç·¨é›† =====================
  document.getElementById("addBtn").addEventListener("click", addTask);
  document.getElementById("taskInput").addEventListener("keydown", e=>{ if(e.key==="Enter") addTask(); });

  function addTask(){
    const name  = document.getElementById("taskInput").value.trim();
    const owner = document.getElementById("ownerInput").value.trim() || "æœªå®š";
    const parentId = document.getElementById("parentSelect").value;
    if (!name) return;

    const newTask = { id: taskId++, name, owner, status: "æœªç€æ‰‹", children: [] };
    if (parentId === ""){
      tasks.push(newTask);
    }else{
      const parent = findTaskById(tasks, parseInt(parentId,10));
      if (parent) parent.children.push(newTask);
    }
    document.getElementById("taskInput").value = "";
    document.getElementById("ownerInput").value = "";
    render();
  }

  function editTask(id){
    const t = findTaskById(tasks,id); if(!t) return;
    const newName  = prompt("æ–°ã—ã„ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›", t.name);
    const newOwner = prompt("æ–°ã—ã„æ‹…å½“è€…ã‚’å…¥åŠ›ï¼ˆæœªå®šå¯ï¼‰", t.owner);
    if (newName !== null && newName.trim() !== "") t.name = newName.trim();
    if (newOwner !== null && newOwner.trim() !== "") t.owner = newOwner.trim();
    render();
  }

  function changeStatus(id, newStatus){
    const t = findTaskById(tasks,id); if(!t) return;
    t.status = newStatus;
    // å­â†’è¦ªã®è‡ªå‹•æ³¢åŠï¼ˆè¦ªã®çŠ¶æ…‹ã‚’è‡ªå‹•æ›´æ–°ï¼‰
    updateParentStatuses(tasks);
    render();
  }

  // ===================== æ¢ç´¢ãƒ»é›†è¨ˆ =====================
  function findTaskById(list, id){
    for(const t of list){
      if (t.id === id) return t;
      const f = findTaskById(t.children,id);
      if (f) return f;
    }
    return null;
  }

  function findMaxId(list){
    let max = -1;
    (function walk(arr){
      for(const t of arr){
        if (t.id > max) max = t.id;
        if (t.children && t.children.length) walk(t.children);
      }
    })(list);
    return max;
  }

  // è¦ªã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹ã‚’å­ã®çŠ¶æ…‹ã‹ã‚‰è‡ªå‹•æ›´æ–°
  function updateParentStatuses(list){
    for(const t of list){
      if (t.children.length){
        updateParentStatuses(t.children);
        const allUnstarted = t.children.every(c => c.status === "æœªç€æ‰‹");
        const allDone      = t.children.every(c => c.status === "å®Œäº†");
        const anyDoing     = t.children.some (c => c.status === "ä½œæ¥­ä¸­");
        t.status = allDone ? "å®Œäº†" : (anyDoing || !allUnstarted ? "ä½œæ¥­ä¸­" : "æœªç€æ‰‹");
      }
    }
  }

  // å­å­«ã®é€²æ—ï¼…ï¼ˆè¦ªç”¨ãƒãƒ¼ï¼‰
  function calcProgressForParent(task){
    let total=0, done=0;
    (function walk(list){
      for(const t of list){
        total++;
        if (t.status==="å®Œäº†") done++;
        if (t.children.length) walk(t.children);
      }
    })(task.children);
    if (total===0) return task.status==="å®Œäº†" ? 100 : 0;
    return Math.round(done/total*100);
  }

  function countAll(list){
    let total=0, done=0;
    (function walk(arr){
      for(const t of arr){
        total++;
        if (t.status==="å®Œäº†") done++;
        if (t.children.length) walk(t.children);
      }
    })(list);
    return {total,done};
  }

  function statsByOwner(){
    const map = {};
    (function walk(arr){
      for(const t of arr){
        if (!map[t.owner]) map[t.owner] = {total:0,done:0};
        map[t.owner].total++;
        if (t.status==="å®Œäº†") map[t.owner].done++;
        if (t.children.length) walk(t.children);
      }
    })(tasks);
    return map;
  }

  // ===================== æç”» =====================
  function render(){
    // è¦ªã®è‡ªå‹•çŠ¶æ…‹ï¼ˆå­å¤‰æ›´ã«ã‚ˆã‚‹æ³¢åŠï¼‰ã‚’å¿µã®ãŸã‚æ¯å›åæ˜ 
    updateParentStatuses(tasks);

    const listEl = document.getElementById("taskList");
    const parentSelect = document.getElementById("parentSelect");
    listEl.innerHTML = "";
    parentSelect.innerHTML = `<option value="">ï¼ˆè¦ªã‚¿ã‚¹ã‚¯ãªã—ï¼‰</option>`;

    function renderTasks(arr, mount){
      for(const t of arr){
        const li = document.createElement("li");
        li.className = "task";

        // 1è¡Œç›®ï¼šãƒãƒƒã‚¸ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æ‹…å½“ãƒ»çŠ¶æ…‹ã‚»ãƒ¬ã‚¯ãƒˆãƒ»ç·¨é›†
        const row = document.createElement("div"); row.className="row";
        const badge = document.createElement("span"); badge.className=`badge ${t.status}`; badge.textContent=t.status;
        const title = document.createElement("span"); title.className="title"; title.textContent = t.name;
        const owner = document.createElement("span"); owner.className="muted"; owner.textContent = `ï¼ˆæ‹…å½“: ${t.owner}ï¼‰`;

        const sel = document.createElement("select");
        STATUS.forEach(s=>{
          const o = document.createElement("option"); o.value=s; o.textContent=s;
          if (t.status===s) o.selected = true;
          sel.appendChild(o);
        });
        sel.onchange = () => changeStatus(t.id, sel.value);

        const edit = document.createElement("button"); edit.textContent="âœï¸ ç·¨é›†"; edit.onclick=()=>editTask(t.id);

        row.appendChild(badge); row.appendChild(title); row.appendChild(owner);
        row.appendChild(sel); row.appendChild(edit);
        li.appendChild(row);

        // è¦ªãªã‚‰é€²æ—ãƒãƒ¼
        if (t.children.length){
          const pct = calcProgressForParent(t);
          const bar = document.createElement("div"); bar.className="progress";
          const fill = document.createElement("span"); fill.style.width = pct+"%";
          bar.appendChild(fill);
          li.appendChild(bar);
        }

        // æ¬¡ã®éšå±¤
        mount.appendChild(li);
        parentSelect.insertAdjacentHTML("beforeend", `<option value="${t.id}">${t.name}</option>`);
        if (t.children.length){
          const sub = document.createElement("ul"); sub.className="tree";
          renderTasks(t.children, sub);
          li.appendChild(sub);
        }
      }
    }
    renderTasks(tasks, listEl);

    // ä¸Šéƒ¨ã®å…¨ä½“ã‚«ã‚¦ãƒ³ã‚¿
    const {total,done} = countAll(tasks);
    const top = document.getElementById("topCounters");
    const percent = total? Math.round(done/total*100) : 0;
    top.innerHTML = `
      <span class="chip">å…¨ä½“: ${done} / ${total} å®Œäº†ï¼ˆ${percent}%ï¼‰</span>
    `;

    // çµ±è¨ˆãƒ‘ãƒãƒ«
    renderStats();

    // è‡ªå‹•ä¸‹æ›¸ãä¿å­˜
    try{ localStorage.setItem("taskbreak_v1", JSON.stringify(tasks)); }catch(e){}
  }

  function renderStats(){
    const box = document.getElementById("statsContent");
    const owners = statsByOwner();
    let html = "";

    // æ‹…å½“è€…åˆ¥
    html += `<div class="stats-row" style="margin-bottom:10px;"><strong>æ‹…å½“è€…åˆ¥</strong></div>`;
    html += `<div style="display:flex;flex-direction:column;gap:8px">`;
    Object.keys(owners).forEach(name=>{
      const {total,done} = owners[name];
      const pct = total? Math.round(done/total*100) : 0;
      html += `
        <div class="stats-row">
          <span class="chip">${name}</span>
          <div class="ownerbar"><span style="width:${pct}%"></span></div>
          <small class="muted">${done}/${total} (${pct}%)</small>
        </div>`;
    });
    html += `</div>`;

    // è¦ªã‚¿ã‚¹ã‚¯åˆ¥
    html += `<hr style="border:none;border-top:1px solid var(--ring);margin:12px 0">`;
    html += `<div class="stats-row" style="margin-bottom:8px;"><strong>è¦ªã‚¿ã‚¹ã‚¯åˆ¥</strong></div>`;
    html += `<div style="display:flex;flex-direction:column;gap:8px">`;
    tasks.forEach(t=>{
      const {total,done} = countAll([t]);
      const pct = total? Math.round(done/total*100) : 0;
      html += `
        <div class="stats-row">
          <span class="chip">${t.name}</span>
          <div class="ownerbar"><span style="width:${pct}%"></span></div>
          <small class="muted">${done}/${total} (${pct}%)</small>
        </div>`;
    });
    html += `</div>`;

    box.innerHTML = html;
  }

  // ===================== çµ±è¨ˆãƒˆã‚°ãƒ« =====================
  document.getElementById("toggleStatsBtn").addEventListener("click", ()=>{
    const p = document.getElementById("statsPanel");
    p.style.display = (p.style.display==="none"||!p.style.display) ? "block" : "none";
  });

  // ===================== ä¿å­˜/èª­ã¿è¾¼ã¿ =====================
  document.getElementById("exportJsonBtn").addEventListener("click", saveTasksJSON);
  document.getElementById("exportMdBtn").addEventListener("click", saveTasksMD);
  document.getElementById("fileInput").addEventListener("change", loadTasks);

  function saveTasksJSON(){
    const data = JSON.stringify(tasks,null,2);
    downloadBlob(data, "tasks.json", "application/json");
  }
  function saveTasksMD(){
    const md = "# ã‚¿ã‚¹ã‚¯ä¸€è¦§\n\n" + toMarkdown(tasks);
    downloadBlob(md, "tasks.md", "text/markdown");
  }
  function toMarkdown(list, depth=0){
    let out = "";
    list.forEach(t=>{
      const indent = "  ".repeat(depth);
      out += `${indent}- (${t.status}) ${t.name} ï¼ˆæ‹…å½“: ${t.owner}ï¼‰\n`;
      if (t.children.length) out += toMarkdown(t.children, depth+1);
    });
    return out;
  }
  function downloadBlob(text, filename, type){
    const blob = new Blob([text], {type});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }
  function loadTasks(e){
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try{
        tasks = JSON.parse(ev.target.result);
        taskId = findMaxId(tasks)+1;
        render();
      }catch(err){ alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
      e.target.value = "";
    };
    reader.readAsText(f);
  }
</script>
</body>
</html>

